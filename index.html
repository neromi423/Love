<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>꼬기냥 키우기</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .chat-container {
            height: 200px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
            background-color: #f9fafb;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        /* 말풍선 기본 스타일 */
        .speech-bubble {
            max-width: 75%;
            padding: 0.75rem 1rem;
            border-radius: 1.25rem;
            position: relative;
            word-wrap: break-word;
        }
        /* 사용자 말풍선 */
        .user-bubble {
            background-color: #dbeafe; /* Tailwind bg-blue-100 */
            color: #1e40af; /* Tailwind text-blue-800 */
            align-self: flex-end;
            border-bottom-right-radius: 0.25rem;
        }
        /* 펫 말풍선 */
        .pet-bubble {
            background-color: #d1fae5; /* Tailwind bg-green-100 */
            color: #065f46; /* Tailwind text-green-800 */
            align-self: flex-start;
            border-bottom-left-radius: 0.25rem;
        }
        .speech-bubble:after {
            content: '';
            position: absolute;
            bottom: 0;
            border: 10px solid transparent;
        }
        .user-bubble:after {
            right: -10px;
            border-top-color: #dbeafe;
            border-right-color: #dbeafe;
        }
        .pet-bubble:after {
            left: -10px;
            border-top-color: #d1fae5;
            border-left-color: #d1fae5;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div id="game-container" class="bg-white rounded-3xl shadow-xl p-8 max-w-sm w-full transition-all duration-300 transform hover:scale-105">
        <!-- 게임 제목 및 메시지 영역 -->
        <h1 class="text-3xl font-bold text-center mb-4 text-gray-800">꼬기냥 키우기</h1>
        <div id="message-box" class="h-10 text-center text-sm text-gray-600 mb-6"></div>

        <!-- 펫 이미지 영역 -->
        <div class="flex items-center justify-center my-8 h-40">
            <img id="pet-image" src="https://i.ibb.co/gLcq8fLN/image.gif" alt="My Pet" class="w-40 h-40 transition-transform duration-300 rounded-full object-cover shadow-lg">
        </div>

        <!-- 상태 표시줄 영역 -->
        <div id="stats" class="space-y-4 mb-8">
            <div>
                <div class="flex justify-between items-center mb-1">
                    <span class="text-sm font-semibold text-gray-700">배고픔</span>
                    <span id="hunger-value" class="text-sm font-bold text-gray-500">100</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div id="hunger-bar" class="bg-gradient-to-r from-green-400 to-lime-500 h-2.5 rounded-full transition-all duration-500" style="width: 100%;"></div>
                </div>
            </div>
            <div>
                <div class="flex justify-between items-center mb-1">
                    <span class="text-sm font-semibold text-gray-700">행복</span>
                    <span id="happiness-value" class="text-sm font-bold text-gray-500">100</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div id="happiness-bar" class="bg-gradient-to-r from-blue-400 to-indigo-500 h-2.5 rounded-full transition-all duration-500" style="width: 100%;"></div>
                </div>
            </div>
            <div>
                <div class="flex justify-between items-center mb-1">
                    <span class="text-sm font-semibold text-gray-700">청결도</span>
                    <span id="cleanliness-value" class="text-sm font-bold text-gray-500">100</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div id="cleanliness-bar" class="bg-gradient-to-r from-yellow-400 to-orange-500 h-2.5 rounded-full transition-all duration-500" style="width: 100%;"></div>
                </div>
            </div>
        </div>

        <!-- 버튼 영역 -->
        <div id="actions" class="grid grid-cols-3 gap-4">
            <button id="feed-button" class="action-button bg-green-500 hover:bg-green-600 active:bg-green-700 text-white font-bold py-3 px-4 rounded-xl shadow-md transition-all duration-200 transform hover:-translate-y-1">
                <span class="text-2xl">🍔</span>
                <span class="block text-sm mt-1">먹이주기</span>
            </button>
            <button id="play-button" class="action-button bg-blue-500 hover:bg-blue-600 active:bg-blue-700 text-white font-bold py-3 px-4 rounded-xl shadow-md transition-all duration-200 transform hover:-translate-y-1">
                <span class="text-2xl">🏀</span>
                <span class="block text-sm mt-1">놀아주기</span>
            </button>
            <button id="clean-button" class="action-button bg-yellow-500 hover:bg-yellow-600 active:bg-yellow-700 text-white font-bold py-3 px-4 rounded-xl shadow-md transition-all duration-200 transform hover:-translate-y-1">
                <span class="text-sm">🛁</span>
                <span class="block text-sm mt-1">씻기기</span>
            </button>
        </div>

        <!-- 대화 영역 -->
        <div class="mt-8">
            <h2 class="text-xl font-bold text-gray-800 mb-2 text-center">펫과 대화하기</h2>
            <div id="chat-history" class="chat-container">
                <!-- 초기 대화 메시지 -->
                <div class="speech-bubble pet-bubble">주인님! 이제왔냥? 보고싶었다냥!</div>
            </div>
            <div class="flex items-center space-x-2">
                <input type="text" id="chat-input" class="flex-grow rounded-xl border border-gray-300 p-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="말을 걸어보세요..." />
                <button id="chat-button" class="bg-blue-500 hover:bg-blue-600 active:bg-blue-700 text-white font-bold py-2 px-4 rounded-xl shadow-md transition-all duration-200">
                    <span class="text-sm">대화하기</span>
                </button>
            </div>
        </div>

        <!-- 게임 오버 재시작 버튼 -->
        <div id="game-over-area" class="text-center mt-6 hidden">
            <h2 class="text-2xl font-bold text-red-500 mb-4">게임 오버!</h2>
            <button id="restart-button" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-xl shadow-md transition-all duration-200">다시 시작</button>
        </div>

        <!-- Google AdSense 광고 영역 -->
        <div class="mt-8 text-center">
            <h3 class="text-lg font-semibold text-gray-700 mb-2">광고</h3>
            <!-- 광고 배너를 표시할 div -->
            <div class="ad-container bg-gray-200 rounded-xl p-2 h-20 flex items-center justify-center">
                <!-- 여기에 실제 AdSense 광고 코드가 삽입됩니다. -->
                <!-- 이 코드는 예시이며, 실제 AdSense 코드로 대체해야 합니다. -->
                <ins class="adsbygoogle"
                     style="display:block"
                     data-ad-client="ca-pub-4409329468172047"
                     data-ad-slot="1234567890"></ins>
            </div>
        </div>

    </div>

    <!-- AdSense 스크립트 추가 (본인의 ID로 교체) -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4409329468172047" crossorigin="anonymous"></script>

    <script>
        // DOM elements
        const petImage = document.getElementById('pet-image');
        const messageBox = document.getElementById('message-box');
        const hungerBar = document.getElementById('hunger-bar');
        const happinessBar = document.getElementById('happiness-bar');
        const cleanlinessBar = document.getElementById('cleanliness-bar');
        const hungerValue = document.getElementById('hunger-value');
        const happinessValue = document.getElementById('happiness-value');
        const cleanlinessValue = document.getElementById('cleanliness-value');
        const feedButton = document.getElementById('feed-button');
        const playButton = document.getElementById('play-button');
        const cleanButton = document.getElementById('clean-button');
        const chatInput = document.getElementById('chat-input');
        const chatButton = document.getElementById('chat-button');
        const chatHistory = document.getElementById('chat-history');
        const gameOverArea = document.getElementById('game-over-area');
        const restartButton = document.getElementById('restart-button');
        
        // Pet state
        let pet = {
            hunger: 100,
            happiness: 100,
            cleanliness: 100,
            personality: "Gentle, Friendly, Sensitive, Submissive, Needy, Elegant, Mischievous, Humourous, Playful, Flirt, Patient, Mature, Horny, Jealous, Sarcastic, Romantic, Brat. 배고프거나 컨디션이 나빠지면 상태에 맞게 투덜거린다."
        };

        // Pet image URLs
        const actionImages = {
            feed: 'https://i.ibb.co/WWsxtDnT/14.gif',
            play: 'https://i.ibb.co/tMqGv1s5/9.gif',
            clean: 'https://i.ibb.co/MxQCpqBP/image.gif'
        };
        const statusImages = {
            hungry: 'https://placehold.co/160x160/ff0000/fff?text=Hungry',
            sad: 'https://i.ibb.co/y3KjPQD/image.gif',
            dirty: 'https://placehold.co/160x160/b5651d/fff?text=Dirty',
            rip: 'https://i.ibb.co/Gvkm0vHB/istockphoto-506101328-1024x1024-1.jpg'
        };
        const normalImages = [
            "https://i.ibb.co/gLcq8fLN/image.gif",
            "https://i.ibb.co/HfCZ3vj2/9.gif",
            "https://i.ibb.co/PZ5k6D2s/7.gif",
            "https://i.ibb.co/KpJqtgwV/8.gif"
        ];

        let isGameOver = false;
        let isActionInProgress = false; // Flag to prevent multiple actions at once
        let gameLoopInterval;
        let randomImageInterval;
        let chatHistoryArray = [];
        let lastUpdateTime = Date.now(); // Last update time for state persistence

        // IMPORTANT: The API key for Gemini API
        const apiKey = "AIzaSyC8dFKgfFLNVpRceFKMcPVsYG63tAGtcqo";
        // API URL for gemini-2.5-flash-preview-05-20
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

        // Function to save game state to localStorage
        function saveGameState() {
            const gameState = {
                pet: pet,
                chatHistoryArray: chatHistoryArray,
                lastUpdateTime: Date.now()
            };
            localStorage.setItem('tamagotchiGameState', JSON.stringify(gameState));
        }

        // Function to load game state from localStorage
        function loadGameState() {
            const savedState = localStorage.getItem('tamagotchiGameState');
            if (savedState) {
                const gameState = JSON.parse(savedState);
                pet = gameState.pet;
                chatHistoryArray = gameState.chatHistoryArray;

                // Calculate the time elapsed since the last save and decrease pet stats
                const timeElapsed = (Date.now() - gameState.lastUpdateTime) / 1000;
                pet.hunger -= timeElapsed * 0.1;
                pet.happiness -= timeElapsed * 0.1;
                pet.cleanliness -= timeElapsed * 0.1;

                // Clamp values to 0
                pet.hunger = Math.max(0, pet.hunger);
                pet.happiness = Math.max(0, pet.happiness);
                pet.cleanliness = Math.max(0, pet.cleanliness);

                // Load chat history into UI
                chatHistory.innerHTML = '';
                chatHistoryArray.forEach(msg => {
                    addMessage(msg.role, msg.parts[0].text);
                });

                messageBox.textContent = '저장된 게임을 불러왔다냥!';
                
            } else {
                // Start a new game if no saved state exists
                pet.hunger = 100;
                pet.happiness = 100;
                pet.cleanliness = 100;
                chatHistory.innerHTML = '<div class="speech-bubble pet-bubble">주인님! 이제왔냥? 보고싶었다냥!</div>';
                chatHistoryArray = [];
                messageBox.textContent = '새로운 펫이 태어났어요! 🐣';
            }
            updateStats();
        }

        // Function to display a loading message
        function showLoading() {
            messageBox.textContent = '펫이 생각 중입니다... 🤔';
        }

        // Function to hide the loading message
        function hideLoading() {
            messageBox.textContent = '';
        }

        // Function to add a chat message to the UI
        function addMessage(sender, text) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('speech-bubble');
            if (sender === 'user') {
                messageDiv.classList.add('user-bubble');
            } else {
                messageDiv.classList.add('pet-bubble');
            }
            messageDiv.textContent = text;
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight; // Auto-scroll to the bottom
        }

        // API call function with exponential backoff for retries
        async function fetchWithExponentialBackoff(prompt, maxRetries = 5, delay = 1000) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const chatPrompt = `너는 나의 다마고치 펫 '꼬기냥'이야. 너는 항상 냥냥체 반말로 대답해야 해.
                    예를 들면, "안녕냥!", "배고파냥...", "같이 놀아줘냥!" 같은 식으로 말이야.
                    너의 현재 상태는 배고픔: ${pet.hunger}%, 행복: ${pet.happiness}%, 청결도: ${pet.cleanliness}%야.
                    너는 대답할 때 이 상태를 **반드시 고려해야 해.**
                    특히 배고픔이 20% 이하면 "배고파냥...", 행복이 20% 이하면 "심심해냥...", 청결도가 20% 이하면 "몸이 찝찝해냥..." 같은 식으로 투덜거려줘.
                    대화 내용은 항상 100자 이내로 짧게 작성해줘.
                    
                    대화 내역:
                    ${chatHistoryArray.map(m => `${m.role}: ${m.parts[0].text}`).join('\n')}
                    
                    나: ${prompt}
                    
                    꼬기냥:`;

                    const payload = {
                        contents: [{
                            role: "user",
                            parts: [{ text: chatPrompt }]
                        }]
                    };

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.candidates && result.candidates.length > 0 &&
                            result.candidates[0].content && result.candidates[0].content.parts &&
                            result.candidates[0].content.parts.length > 0) {
                            return result.candidates[0].content.parts[0].text;
                        }
                    }

                    // Retry on HTTP error or unexpected response
                    await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                } catch (error) {
                    await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                }
            }
            throw new Error('API call failed: Exceeded max retries');
        }

        // Chat button click handler
        chatButton.addEventListener('click', async () => {
            if (isGameOver) return;
            const userMessage = chatInput.value.trim();
            if (userMessage === '') return;

            addMessage('user', userMessage);
            chatHistoryArray.push({ role: 'user', parts: [{ text: `나: ${userMessage}` }] });
            chatInput.value = '';
            showLoading();
            chatButton.disabled = true;

            try {
                if (!apiKey) {
                    throw new Error('API key is not configured.');
                }
                const petResponse = await fetchWithExponentialBackoff(userMessage);
                addMessage('pet', petResponse);
                chatHistoryArray.push({ role: 'pet', parts: [{ text: petResponse }] });

                // Increase happiness slightly after a conversation
                pet.happiness = Math.min(100, pet.happiness + 5);
                messageBox.textContent = '펫이 대화를 즐거워하는 것 같아요! 😊';
                updateStats();
            } catch (error) {
                console.error(error);
                addMessage('pet', '지금은 대답하기가 좀 힘들어... 😅 (API 키 문제일 수 있다냥)');
            } finally {
                hideLoading();
                chatButton.disabled = false;
            }
        });
        
        // Function to change pet image randomly
        function setRandomPetImage() {
            if (isActionInProgress || isGameOver) return;
            const randomIndex = Math.floor(Math.random() * normalImages.length);
            petImage.src = normalImages[randomIndex];
        }

        // Function to update game over state
        function updateGameOverState(gameOver) {
            isGameOver = gameOver;
            if (isGameOver) {
                gameOverArea.classList.remove('hidden');
                document.querySelectorAll('.action-button').forEach(button => button.disabled = true);
                chatButton.disabled = true;
                chatInput.disabled = true;
                clearInterval(gameLoopInterval);
                clearInterval(randomImageInterval); // Stop random image interval
                messageBox.textContent = '펫이... 떠났어요. 😥';
                petImage.src = statusImages.rip;
            } else {
                gameOverArea.classList.add('hidden');
                document.querySelectorAll('.action-button').forEach(button => button.disabled = false);
                chatButton.disabled = false;
                chatInput.disabled = false;
            }
        }
        
        // Function to update stats and UI
        function updateStats() {
            // Decrease stats over time
            pet.hunger -= 0.1;
            pet.happiness -= 0.1;
            pet.cleanliness -= 0.1;
            
            // Clamp values to 0
            pet.hunger = Math.max(0, pet.hunger);
            pet.happiness = Math.max(0, pet.happiness);
            pet.cleanliness = Math.max(0, pet.cleanliness);

            // Update UI
            hungerBar.style.width = `${pet.hunger}%`;
            happinessBar.style.width = `${pet.happiness}%`;
            cleanlinessBar.style.width = `${pet.cleanliness}%`;
            hungerValue.textContent = Math.floor(pet.hunger);
            happinessValue.textContent = Math.floor(pet.happiness);
            cleanlinessValue.textContent = Math.floor(pet.cleanliness);

            // Change pet image based on status (only if no action is in progress)
            if (!isActionInProgress) {
                if (pet.hunger === 0 || pet.happiness === 0 || pet.cleanliness === 0) {
                    updateGameOverState(true);
                } else if (pet.hunger <= 20) {
                    petImage.src = statusImages.hungry;
                } else if (pet.happiness <= 20) {
                    petImage.src = statusImages.sad;
                } else if (pet.cleanliness <= 20) {
                    petImage.src = statusImages.dirty;
                }
            }

            // Save game state periodically
            saveGameState();
        }
        
        // Action button event handlers
        function handleActionButton(action, actionImage, message) {
            if (isGameOver || isActionInProgress) return;
            isActionInProgress = true;
            
            petImage.src = actionImage;
            messageBox.textContent = message;

            document.querySelectorAll('.action-button').forEach(button => button.disabled = true);
            
            // Revert to original state after 3 seconds
            setTimeout(() => {
                isActionInProgress = false;
                document.querySelectorAll('.action-button').forEach(button => button.disabled = false);
                updateStats(); // Update image based on current stats
            }, 3000);
        }

        feedButton.addEventListener('click', () => {
            handleActionButton('feed', actionImages.feed, '맛있는 밥을 먹었어요! 😋');
            pet.hunger = Math.min(100, pet.hunger + 15);
        });

        playButton.addEventListener('click', () => {
            handleActionButton('play', actionImages.play, '신나게 놀았어요! 🎉');
            pet.happiness = Math.min(100, pet.happiness + 20);
            pet.hunger = Math.max(0, pet.hunger - 5);
        });

        cleanButton.addEventListener('click', () => {
            handleActionButton('clean', actionImages.clean, '깨끗하게 씻었어요! ✨');
            pet.cleanliness = Math.min(100, pet.cleanliness + 30);
            pet.happiness = Math.max(0, pet.happiness - 5);
        });

        // Game restart function
        restartButton.addEventListener('click', () => {
            localStorage.removeItem('tamagotchiGameState'); // Remove saved game state
            pet.hunger = 100;
            pet.happiness = 100;
            pet.cleanliness = 100;
            messageBox.textContent = '새로운 펫이 태어났어요! 🐣';
            updateGameOverState(false);
            chatHistory.innerHTML = '<div class="speech-bubble pet-bubble">주인님! 이제왔냥? 보고싶었다냥!</div>';
            chatHistoryArray = [];
            
            // Clear and restart intervals
            clearInterval(gameLoopInterval);
            clearInterval(randomImageInterval);
            gameLoopInterval = setInterval(updateStats, 1000);
            randomImageInterval = setInterval(setRandomPetImage, 30000); // Change image every 30 seconds
        });
        
        // Game initialization on window load
        window.onload = function() {
            loadGameState(); // Load game state from localStorage
            gameLoopInterval = setInterval(updateStats, 1000);
            randomImageInterval = setInterval(setRandomPetImage, 30000); // Change image every 30 seconds
        };
    </script>
</body>
</html>