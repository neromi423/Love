<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¼¬ê¸°ëƒ¥ í‚¤ìš°ê¸°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .chat-container {
            height: 200px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
            background-color: #f9fafb;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        /* ë§í’ì„  ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        .speech-bubble {
            max-width: 75%;
            padding: 0.75rem 1rem;
            border-radius: 1.25rem;
            position: relative;
            word-wrap: break-word;
        }
        /* ì‚¬ìš©ì ë§í’ì„  */
        .user-bubble {
            background-color: #dbeafe; /* Tailwind bg-blue-100 */
            color: #1e40af; /* Tailwind text-blue-800 */
            align-self: flex-end;
            border-bottom-right-radius: 0.25rem;
        }
        /* í« ë§í’ì„  */
        .pet-bubble {
            background-color: #d1fae5; /* Tailwind bg-green-100 */
            color: #065f46; /* Tailwind text-green-800 */
            align-self: flex-start;
            border-bottom-left-radius: 0.25rem;
        }
        .speech-bubble:after {
            content: '';
            position: absolute;
            bottom: 0;
            border: 10px solid transparent;
        }
        .user-bubble:after {
            right: -10px;
            border-top-color: #dbeafe;
            border-right-color: #dbeafe;
        }
        .pet-bubble:after {
            left: -10px;
            border-top-color: #d1fae5;
            border-left-color: #d1fae5;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .leaderboard-list {
            list-style: none;
            padding: 0;
            max-height: 250px;
            overflow-y: auto;
        }
        .leaderboard-list li {
            background-color: #f9fafb;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .leaderboard-list li:first-child {
            background-color: #fffbeb;
            border: 2px solid #fde68a;
            font-weight: bold;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div id="game-container" class="bg-white rounded-3xl shadow-xl p-8 max-w-sm w-full transition-all duration-300 transform hover:scale-105">
        <!-- ì‚¬ìš©ì ID í‘œì‹œ ì˜ì—­ -->
        <div class="text-xs text-gray-500 mb-4 break-all">
            <span class="font-bold">ì‚¬ìš©ì ID:</span> <span id="user-id">ì¸ì¦ ì¤‘...</span>
        </div>

        <!-- ê²Œì„ ì œëª© ë° ë©”ì‹œì§€ ì˜ì—­ -->
        <h1 class="text-3xl font-bold text-center mb-4 text-gray-800">ê¼¬ê¸°ëƒ¥ í‚¤ìš°ê¸°</h1>
        <div id="message-box" class="h-10 text-center text-sm text-gray-600 mb-6"></div>

        <!-- í« ì´ë¯¸ì§€ ì˜ì—­ -->
        <div class="flex items-center justify-center my-8 h-40">
            <img id="pet-image" src="https://i.ibb.co/gLcq8fLN/image.gif" alt="My Pet" class="w-40 h-40 transition-transform duration-300 rounded-full object-cover shadow-lg">
        </div>

        <!-- ìƒíƒœ í‘œì‹œì¤„ ì˜ì—­ -->
        <div id="stats" class="space-y-4 mb-8">
            <div>
                <div class="flex justify-between items-center mb-1">
                    <span class="text-sm font-semibold text-gray-700">ë°°ê³ í””</span>
                    <span id="hunger-value" class="text-sm font-bold text-gray-500">100</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div id="hunger-bar" class="bg-gradient-to-r from-green-400 to-lime-500 h-2.5 rounded-full transition-all duration-500" style="width: 100%;"></div>
                </div>
            </div>
            <div>
                <div class="flex justify-between items-center mb-1">
                    <span class="text-sm font-semibold text-gray-700">í–‰ë³µ</span>
                    <span id="happiness-value" class="text-sm font-bold text-gray-500">100</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div id="happiness-bar" class="bg-gradient-to-r from-blue-400 to-indigo-500 h-2.5 rounded-full transition-all duration-500" style="width: 100%;"></div>
                </div>
            </div>
            <div>
                <div class="flex justify-between items-center mb-1">
                    <span class="text-sm font-semibold text-gray-700">ì²­ê²°ë„</span>
                    <span id="cleanliness-value" class="text-sm font-bold text-gray-500">100</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div id="cleanliness-bar" class="bg-gradient-to-r from-yellow-400 to-orange-500 h-2.5 rounded-full transition-all duration-500" style="width: 100%;"></div>
                </div>
            </div>
        </div>

        <!-- ë²„íŠ¼ ì˜ì—­ -->
        <div id="actions" class="grid grid-cols-3 gap-4">
            <button id="feed-button" class="action-button bg-green-500 hover:bg-green-600 active:bg-green-700 text-white font-bold py-3 px-4 rounded-xl shadow-md transition-all duration-200 transform hover:-translate-y-1">
                <span class="text-2xl">ğŸ”</span>
                <span class="block text-sm mt-1">ë¨¹ì´ì£¼ê¸°</span>
            </button>
            <button id="play-button" class="action-button bg-blue-500 hover:bg-blue-600 active:bg-blue-700 text-white font-bold py-3 px-4 rounded-xl shadow-md transition-all duration-200 transform hover:-translate-y-1">
                <span class="text-2xl">ğŸ€</span>
                <span class="block text-sm mt-1">ë†€ì•„ì£¼ê¸°</span>
            </button>
            <button id="clean-button" class="action-button bg-yellow-500 hover:bg-yellow-600 active:bg-yellow-700 text-white font-bold py-3 px-4 rounded-xl shadow-md transition-all duration-200 transform hover:-translate-y-1">
                <span class="text-sm">ğŸ›</span>
                <span class="block text-sm mt-1">ì”»ê¸°ê¸°</span>
            </button>
        </div>

        <!-- ëŒ€í™” ì˜ì—­ -->
        <div class="mt-8">
            <h2 class="text-xl font-bold text-gray-800 mb-2 text-center">í«ê³¼ ëŒ€í™”í•˜ê¸°</h2>
            <div id="chat-history" class="chat-container">
                <!-- ì´ˆê¸° ëŒ€í™” ë©”ì‹œì§€ -->
                <div class="speech-bubble pet-bubble">ì£¼ì¸ë‹˜! ì´ì œì™”ëƒ¥? ë³´ê³ ì‹¶ì—ˆë‹¤ëƒ¥!</div>
            </div>
            <div class="flex items-center space-x-2">
                <input type="text" id="chat-input" class="flex-grow rounded-xl border border-gray-300 p-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ë§ì„ ê±¸ì–´ë³´ì„¸ìš”..." />
                <button id="chat-button" class="bg-blue-500 hover:bg-blue-600 active:bg-blue-700 text-white font-bold py-2 px-4 rounded-xl shadow-md transition-all duration-200">
                    <span class="text-sm">ëŒ€í™”í•˜ê¸°</span>
                </button>
            </div>
        </div>

        <!-- ê²Œì„ ì˜¤ë²„ ì¬ì‹œì‘ ë²„íŠ¼ -->
        <div id="game-over-area" class="text-center mt-6 hidden">
            <h2 class="text-2xl font-bold text-red-500 mb-4">ê²Œì„ ì˜¤ë²„!</h2>
            <button id="restart-button" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-xl shadow-md transition-all duration-200">ë‹¤ì‹œ ì‹œì‘</button>
        </div>

        <!-- ë­í‚¹ ë³´ë“œ ì˜ì—­ -->
        <div id="leaderboard-container" class="mt-8">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-4">ëª…ì˜ˆì˜ ì „ë‹¹ (Top 15)</h2>
            <ol id="leaderboard-list" class="leaderboard-list"></ol>
        </div>

        <!-- Google AdSense ê´‘ê³  ì˜ì—­ -->
        <div class="mt-8 text-center">
            <h3 class="text-lg font-semibold text-gray-700 mb-2">ê´‘ê³ </h3>
            <div class="ad-container bg-gray-200 rounded-xl p-2 h-20 flex items-center justify-center">
                <ins class="adsbygoogle"
                     style="display:block"
                     data-ad-client="ca-pub-4409329468172047"
                     data-ad-slot="1234567890"></ins>
            </div>
        </div>

    </div>

    <!-- ì§‘ì‚¬ ì´ë¦„ ì…ë ¥ ëª¨ë‹¬ -->
    <div id="name-modal" class="modal hidden">
        <div class="modal-content text-center">
            <h3 class="text-2xl font-bold mb-4">ê²Œì„ ì˜¤ë²„! í«ì´ ë– ë‚¬ì–´ìš”. ğŸ˜¥</h3>
            <p class="mb-4">ë­í‚¹ì— ê¸°ë¡ë  ì§‘ì‚¬ ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.</p>
            <input type="text" id="butler-name-input" class="w-full p-2 border rounded-md mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ì§‘ì‚¬ ì´ë¦„" maxlength="15">
            <button id="submit-name-button" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 rounded-xl">ë­í‚¹ ë“±ë¡</button>
        </div>
    </div>

    <!-- Firebase SDK Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, doc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Firebase Initialization and Auth ---
        
        // Firestore ë° Auth ê°ì²´ë¥¼ ì €ì¥í•  ë³€ìˆ˜
        let db;
        let auth;
        let userId;
        let currentScoreDocId = null; // í˜„ì¬ ê²Œì„ì˜ ë­í‚¹ ë¬¸ì„œ ID

        // Firebase ì„¤ì • (í™˜ê²½ ë³€ìˆ˜ ì‚¬ìš©)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        async function initFirebase() {
            try {
                console.log("Firebase ì´ˆê¸°í™” ì‹œì‘...");
                // Firebase ì•± ì´ˆê¸°í™”
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                console.log("Firebase ì•± ë° DB ì´ˆê¸°í™” ì™„ë£Œ.");

                // Check for a pre-provided custom auth token, otherwise sign in anonymously.
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (initialAuthToken) {
                    console.log("ì»¤ìŠ¤í…€ í† í°ìœ¼ë¡œ ë¡œê·¸ì¸ ì‹œë„ ì¤‘...");
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("ì»¤ìŠ¤í…€ í† í°ìœ¼ë¡œ ë¡œê·¸ì¸ ì„±ê³µ.");
                } else {
                    console.log("ìµëª… ë¡œê·¸ì¸ ì‹œë„ ì¤‘...");
                    await signInAnonymously(auth);
                    console.log("ìµëª… ë¡œê·¸ì¸ ì„±ê³µ.");
                }

                // ì¸ì¦ ìƒíƒœ ë³€ê²½ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id').textContent = userId;
                        console.log("ì‚¬ìš©ì ì¸ì¦ ì™„ë£Œ. User ID:", userId);
                        
                        // ì¸ì¦ì´ ì™„ë£Œë˜ë©´ ê²Œì„ì„ ì‹œì‘
                        startGame();

                    } else {
                        // ì‚¬ìš©ì IDê°€ ì—†ìœ¼ë©´ ì„ì˜ì˜ IDë¥¼ í• ë‹¹ (ë­í‚¹ì— ë“±ë¡ë˜ì§€ ì•ŠìŒ)
                        userId = crypto.randomUUID();
                        document.getElementById('user-id').textContent = userId;
                        console.log("ì‚¬ìš©ì ì¸ì¦ ì‹¤íŒ¨. ì„ì˜ì˜ User ID í• ë‹¹:", userId);
                        
                        // ì¸ì¦ ì‹¤íŒ¨ ì‹œì—ë„ ê²Œì„ ì‹œì‘ (ë­í‚¹ ê¸°ëŠ¥ë§Œ ì œí•œ)
                        startGame();
                    }
                });

            } catch (error) {
                console.error("Firebase ì´ˆê¸°í™” ë˜ëŠ” ë¡œê·¸ì¸ ì‹¤íŒ¨:", error);
                document.getElementById('user-id').textContent = 'ë¡œê·¸ì¸ ì‹¤íŒ¨';
            }
        }
        
        // --- Game Initialization and Loops ---
        function startGame() {
            console.log("startGame í•¨ìˆ˜ í˜¸ì¶œë¨. ê²Œì„ ë£¨í”„ ë° ë­í‚¹ ë¦¬ìŠ¤ë„ˆ ì‹œì‘.");
            loadGameState();
            listenForLeaderboardUpdates();
            
            // ëª¨ë“  ê²Œì„ ë£¨í”„ë¥¼ í•œ ê³³ì—ì„œ ì‹œì‘
            gameLoopInterval = setInterval(updateStats, 1000);
            randomImageInterval = setInterval(setRandomPetImage, 30000);
            scoreUpdateInterval = setInterval(updateCurrentScore, 5000); // 5ì´ˆë§ˆë‹¤ ì ìˆ˜ ì—…ë°ì´íŠ¸
        }
        
        // --- Leaderboard Functions ---

        // ë­í‚¹ ë³´ë“œë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ì—…ë°ì´íŠ¸í•˜ëŠ” ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        function listenForLeaderboardUpdates() {
            if (!db) {
                 console.error("listenForLeaderboardUpdates: DBê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                 return;
            }
            
            const leaderboardCollectionPath = `artifacts/${appId}/public/data/leaderboard`;
            const leaderboardRef = collection(db, leaderboardCollectionPath);
            
            onSnapshot(leaderboardRef, (snapshot) => {
                const scores = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    scores.push(data);
                });

                // ì ìˆ˜ë¥¼ ìƒì¡´ ì‹œê°„(survivalTime) ê¸°ì¤€ìœ¼ë¡œ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
                scores.sort((a, b) => b.survivalTime - a.survivalTime);

                const leaderboardList = document.getElementById('leaderboard-list');
                leaderboardList.innerHTML = ''; // ê¸°ì¡´ ëª©ë¡ ì´ˆê¸°í™”

                // ìƒìœ„ 15ê°œ í•­ëª©ë§Œ í‘œì‹œ
                const top15 = scores.slice(0, 15);
                top15.forEach((score, index) => {
                    const listItem = document.createElement('li');
                    listItem.classList.add('flex', 'justify-between', 'items-center', 'bg-white', 'p-3', 'rounded-lg', 'shadow-sm', 'mb-2');
                    
                    const rank = index + 1;
                    const formattedSurvivalTime = formatTime(score.survivalTime);

                    listItem.innerHTML = `
                        <div class="flex items-center space-x-2">
                            <span class="font-bold text-lg text-gray-700 w-6">${rank}.</span>
                            <span class="text-gray-900 font-medium">${score.name}</span>
                        </div>
                        <span class="text-gray-600">${formattedSurvivalTime}</span>
                    `;
                    leaderboardList.appendChild(listItem);
                });
                console.log("ë­í‚¹ ë³´ë“œê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.");
            }, (error) => {
                console.error("ë­í‚¹ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", error);
            });
        }
        
        // Helper function to format survival time
        function formatTime(seconds) {
            if (seconds === 0) return '0ì´ˆ';
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            let timeString = '';
            if (minutes > 0) {
                timeString += `${minutes}ë¶„ `;
            }
            if (remainingSeconds > 0) {
                timeString += `${remainingSeconds}ì´ˆ`;
            }
            return timeString.trim();
        }

        // --- Game Logic ---
        
        // DOM elements
        const petImage = document.getElementById('pet-image');
        const messageBox = document.getElementById('message-box');
        const hungerBar = document.getElementById('hunger-bar');
        const happinessBar = document.getElementById('happiness-bar');
        const cleanlinessBar = document.getElementById('cleanliness-bar');
        const hungerValue = document.getElementById('hunger-value');
        const happinessValue = document.getElementById('happiness-value');
        const cleanlinessValue = document.getElementById('cleanliness-value');
        const feedButton = document.getElementById('feed-button');
        const playButton = document.getElementById('play-button');
        const cleanButton = document.getElementById('clean-button');
        const chatInput = document.getElementById('chat-input');
        const chatButton = document.getElementById('chat-button');
        const chatHistory = document.getElementById('chat-history');
        const gameOverArea = document.getElementById('game-over-area');
        const restartButton = document.getElementById('restart-button');
        const nameModal = document.getElementById('name-modal');
        const butlerNameInput = document.getElementById('butler-name-input');
        const submitNameButton = document.getElementById('submit-name-button');
        
        // Pet state
        let pet = {
            hunger: 100,
            happiness: 100,
            cleanliness: 100
        };

        // Pet image URLs
        const actionImages = {
            feed: 'https://i.ibb.co/WWsxtDnT/14.gif',
            play: 'https://i.ibb.co/tMqGv1s5/9.gif',
            clean: 'https://i.ibb.co/MxQCpqBP/image.gif'
        };
        const statusImages = {
            hungry: 'https://i.ibb.co/9kzzt9tD/1755154938836.gif',
            sad: 'https://i.ibb.co/y3KjPQD/image.gif',
            dirty: 'https://i.ibb.co/9kzzt9tD/1755154938836.gif',
            rip: 'https://i.ibb.co/Gvkm0vHB/istockphoto-506101328-1024x1024-1.jpg'
        };
        const normalImages = [
            "https://i.ibb.co/gLcq8fLN/image.gif",
            "https://i.ibb.co/HfCZ3vj2/9.gif",
            "https://i.ibb.co/PZ5k6D2s/7.gif",
            "https://i.ibb.co/KpJqtgwV/8.gif"
        ];

        let isGameOver = false;
        let isActionInProgress = false;
        let gameLoopInterval;
        let randomImageInterval;
        let chatHistoryArray = [];
        let startTime;
        let scoreUpdateInterval; // Firestore ì ìˆ˜ ì—…ë°ì´íŠ¸ ê°„ê²©

        // IMPORTANT: The API key for Gemini API
        const geminiApiKey = "AIzaSyC8dFKgfFLNVpRceFKMcPVsYG63tAGtcqo";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${geminiApiKey}`;

        // Function to save game state to localStorage
        function saveGameState() {
            const gameState = {
                pet: pet,
                chatHistoryArray: chatHistoryArray,
                startTime: startTime,
                currentScoreDocId: currentScoreDocId // Save the current score doc id
            };
            localStorage.setItem('tamagotchiGameState', JSON.stringify(gameState));
            console.log("ê²Œì„ ìƒíƒœê°€ ë¡œì»¬ ì €ì¥ì†Œì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }

        // Function to load game state from localStorage
        function loadGameState() {
            const savedState = localStorage.getItem('tamagotchiGameState');
            if (savedState) {
                const gameState = JSON.parse(savedState);
                pet = gameState.pet;
                chatHistoryArray = gameState.chatHistoryArray;
                startTime = gameState.startTime;
                currentScoreDocId = gameState.currentScoreDocId;
                
                console.log("ì €ì¥ëœ ê²Œì„ ìƒíƒœë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.");

                const timeElapsed = (Date.now() - startTime) / 1000;
                pet.hunger -= timeElapsed * 0.1;
                pet.happiness -= timeElapsed * 0.1;
                pet.cleanliness -= timeElapsed * 0.1;

                pet.hunger = Math.max(0, pet.hunger);
                pet.happiness = Math.max(0, pet.happiness);
                pet.cleanliness = Math.max(0, pet.cleanliness);

                chatHistory.innerHTML = '';
                chatHistoryArray.forEach(msg => {
                    addMessage(msg.role, msg.parts[0].text);
                });

                messageBox.textContent = 'ì €ì¥ëœ ê²Œì„ì„ ë¶ˆëŸ¬ì™”ë‹¤ëƒ¥!';
                
            } else {
                console.log("ì €ì¥ëœ ìƒíƒœ ì—†ìŒ. ìƒˆë¡œìš´ ê²Œì„ì„ ì‹œì‘í•©ë‹ˆë‹¤.");
                startNewGame();
            }
            updateStats();
        }
        
        async function startNewGame() {
             // Set initial pet stats and start time
             pet.hunger = 100;
             pet.happiness = 100;
             pet.cleanliness = 100;
             messageBox.textContent = 'ìƒˆë¡œìš´ í«ì´ íƒœì–´ë‚¬ì–´ìš”! ğŸ£';
             chatHistory.innerHTML = '<div class="speech-bubble pet-bubble">ì£¼ì¸ë‹˜! ì´ì œì™”ëƒ¥? ë³´ê³ ì‹¶ì—ˆë‹¤ëƒ¥!</div>';
             chatHistoryArray = [];
             startTime = Date.now();
            
            // Create a new score document in Firestore with a placeholder name
            try {
                if (db && userId) {
                    const leaderboardCollectionPath = `artifacts/${appId}/public/data/leaderboard`;
                    const newScoreDoc = await addDoc(collection(db, leaderboardCollectionPath), {
                        name: 'ìµëª…ì˜ ì§‘ì‚¬', // Anonymous name
                        survivalTime: 0,
                        timestamp: serverTimestamp(),
                        userId: userId,
                    });
                    currentScoreDocId = newScoreDoc.id;
                    console.log("ìƒˆ ë­í‚¹ ë¬¸ì„œ ìƒì„± ì™„ë£Œ:", currentScoreDocId);
                    saveGameState();
                } else {
                    console.warn("DB ë˜ëŠ” userIdê°€ ì—†ì–´ ìƒˆ ë­í‚¹ ë¬¸ì„œë¥¼ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                }
            } catch (e) {
                console.error("ë­í‚¹ ë¬¸ì„œ ìƒì„± ì‹¤íŒ¨:", e);
            }
        }

        function showLoading() {
            messageBox.textContent = 'í«ì´ ìƒê° ì¤‘ì…ë‹ˆë‹¤... ğŸ¤”';
        }

        function hideLoading() {
            messageBox.textContent = '';
        }

        function addMessage(sender, text) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('speech-bubble');
            if (sender === 'user') {
                messageDiv.classList.add('user-bubble');
            } else {
                messageDiv.classList.add('pet-bubble');
            }
            messageDiv.textContent = text;
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        async function fetchWithExponentialBackoff(prompt, maxRetries = 5, delay = 1000) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const chatPrompt = `ë„ˆëŠ” ë‚˜ì˜ ë‹¤ë§ˆê³ ì¹˜ í« 'ê¼¬ê¸°ëƒ¥'ì´ì•¼. ë„ˆëŠ” í•­ìƒ ëƒ¥ëƒ¥ì²´ ë°˜ë§ë¡œ ëŒ€ë‹µí•´ì•¼ í•´.
                    ì˜ˆë¥¼ ë“¤ë©´, "ì•ˆë…•ëƒ¥!", "ë°°ê³ íŒŒëƒ¥...", "ê°™ì´ ë†€ì•„ì¤˜ëƒ¥!" ê°™ì€ ì‹ìœ¼ë¡œ ë§ì´ì•¼.
                    ë„ˆì˜ í˜„ì¬ ìƒíƒœëŠ” ë°°ê³ í””: ${pet.hunger}%, í–‰ë³µ: ${pet.happiness}%, ì²­ê²°ë„: ${pet.cleanliness}%ì•¼.
                    ë„ˆëŠ” ëŒ€ë‹µí•  ë•Œ ì´ ìƒíƒœë¥¼ **ë°˜ë“œì‹œ ê³ ë ¤í•´ì•¼ í•´.**
                    íŠ¹íˆ ë°°ê³ í””ì´ 20% ì´í•˜ë©´ "ë°°ê³ íŒŒëƒ¥...", í–‰ë³µì´ 20% ì´í•˜ë©´ "ì‹¬ì‹¬í•´ëƒ¥...", ì²­ê²°ë„ê°€ 20% ì´í•˜ë©´ "ëª¸ì´ ì°ì°í•´ëƒ¥..." ê°™ì€ ì‹ìœ¼ë¡œ íˆ¬ëœê±°ë ¤ì¤˜.
                    ëŒ€í™” ë‚´ìš©ì€ í•­ìƒ 100ì ì´ë‚´ë¡œ ì§§ê²Œ ì‘ì„±í•´ì¤˜.
                    
                    ëŒ€í™” ë‚´ì—­:
                    ${chatHistoryArray.map(m => `${m.role}: ${m.parts[0].text}`).join('\n')}
                    
                    ë‚˜: ${prompt}
                    
                    ê¼¬ê¸°ëƒ¥:`;

                    const payload = {
                        contents: [{
                            role: "user",
                            parts: [{ text: chatPrompt }]
                        }]
                    };

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.candidates && result.candidates.length > 0 &&
                            result.candidates[0].content && result.candidates[0].content.parts &&
                            result.candidates[0].content.parts.length > 0) {
                            return result.candidates[0].content.parts[0].text;
                        }
                    }
                    console.log(`API í˜¸ì¶œ ì‹¤íŒ¨. ì¬ì‹œë„ (${i + 1}/${maxRetries}).`);
                    await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                } catch (error) {
                    console.error(`API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ. ì¬ì‹œë„ (${i + 1}/${maxRetries}):`, error);
                    await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                }
            }
            throw new Error('API call failed: Exceeded max retries');
        }

        chatButton.addEventListener('click', async () => {
            if (isGameOver) return;
            const userMessage = chatInput.value.trim();
            if (userMessage === '') return;

            addMessage('user', userMessage);
            chatHistoryArray.push({ role: 'user', parts: [{ text: `ë‚˜: ${userMessage}` }] });
            chatInput.value = '';
            showLoading();
            chatButton.disabled = true;

            try {
                if (!geminiApiKey) {
                    throw new Error('API key is not configured.');
                }
                const petResponse = await fetchWithExponentialBackoff(userMessage);
                addMessage('pet', petResponse);
                chatHistoryArray.push({ role: 'pet', parts: [{ text: petResponse }] });

                pet.happiness = Math.min(100, pet.happiness + 5);
                messageBox.textContent = 'í«ì´ ëŒ€í™”ë¥¼ ì¦ê±°ì›Œí•˜ëŠ” ê²ƒ ê°™ì•„ìš”! ğŸ˜Š';
                updateStats();
            } catch (error) {
                console.error(error);
                addMessage('pet', 'ì§€ê¸ˆì€ ëŒ€ë‹µí•˜ê¸°ê°€ ì¢€ í˜ë“¤ì–´... ğŸ˜… (API í‚¤ ë¬¸ì œì¼ ìˆ˜ ìˆë‹¤ëƒ¥)');
            } finally {
                hideLoading();
                chatButton.disabled = false;
            }
        });
        
        function setRandomPetImage() {
            if (isActionInProgress || isGameOver) return;
            const randomIndex = Math.floor(Math.random() * normalImages.length);
            petImage.src = normalImages[randomIndex];
        }

        function updateGameOverState(gameOver) {
            if (isGameOver === gameOver) return; // ìƒíƒœ ë³€í™”ê°€ ì—†ìœ¼ë©´ ë¦¬í„´
            isGameOver = gameOver;
            if (isGameOver) {
                console.log("ê²Œì„ ì˜¤ë²„ ìƒíƒœ ì§„ì…!");
                // ê²Œì„ ì˜¤ë²„ UI í‘œì‹œ
                gameOverArea.classList.remove('hidden');
                document.querySelectorAll('.action-button').forEach(button => button.disabled = true);
                chatButton.disabled = true;
                chatInput.disabled = true;
                clearInterval(gameLoopInterval);
                clearInterval(randomImageInterval);
                clearInterval(scoreUpdateInterval);
                messageBox.textContent = 'í«ì´... ë– ë‚¬ì–´ìš”. ğŸ˜¥';
                petImage.src = statusImages.rip;
                
                // ì´ë¦„ ì…ë ¥ ëª¨ë‹¬ í‘œì‹œ
                nameModal.classList.remove('hidden');

            } else {
                gameOverArea.classList.add('hidden');
                document.querySelectorAll('.action-button').forEach(button => button.disabled = false);
                chatButton.disabled = false;
                chatInput.disabled = false;
            }
        }
        
        function updateStats() {
            if (isGameOver) return;
            
            pet.hunger -= 0.1;
            pet.happiness -= 0.1;
            pet.cleanliness -= 0.1;
            
            pet.hunger = Math.max(0, pet.hunger);
            pet.happiness = Math.max(0, pet.happiness);
            pet.cleanliness = Math.max(0, pet.cleanliness);

            hungerBar.style.width = `${pet.hunger}%`;
            happinessBar.style.width = `${pet.happiness}%`;
            cleanlinessBar.style.width = `${pet.cleanliness}%`;
            hungerValue.textContent = Math.floor(pet.hunger);
            happinessValue.textContent = Math.floor(pet.happiness);
            cleanlinessValue.textContent = Math.floor(pet.cleanliness);
            
            // ìƒíƒœì— ë”°ë¥¸ ì´ë¯¸ì§€ ë³€ê²½
            if (!isActionInProgress) {
                if (pet.hunger === 0 || pet.happiness === 0 || pet.cleanliness === 0) {
                    updateGameOverState(true);
                } else if (pet.hunger <= 20) {
                    petImage.src = statusImages.hungry;
                } else if (pet.happiness <= 20) {
                    petImage.src = statusImages.sad;
                } else if (pet.cleanliness <= 20) {
                    petImage.src = statusImages.dirty;
                }
            }
            saveGameState();
        }
        
        // Firestoreì— í˜„ì¬ ì ìˆ˜ ì—…ë°ì´íŠ¸
        async function updateCurrentScore() {
            if (!db || !currentScoreDocId) return;
            const survivalTime = Math.floor((Date.now() - startTime) / 1000);

            try {
                const leaderboardCollectionPath = `artifacts/${appId}/public/data/leaderboard`;
                const scoreDocRef = doc(db, leaderboardCollectionPath, currentScoreDocId);
                await updateDoc(scoreDocRef, {
                    survivalTime: survivalTime
                });
                console.log("í˜„ì¬ ì ìˆ˜ê°€ Firestoreì— ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.");
            } catch (e) {
                console.error("í˜„ì¬ ì ìˆ˜ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:", e);
            }
        }
        
        function handleActionButton(action, actionImage, message) {
            if (isGameOver || isActionInProgress) return;
            isActionInProgress = true;
            
            petImage.src = actionImage;
            messageBox.textContent = message;

            document.querySelectorAll('.action-button').forEach(button => button.disabled = true);
            
            setTimeout(() => {
                isActionInProgress = false;
                document.querySelectorAll('.action-button').forEach(button => button.disabled = false);
                updateStats();
            }, 3000);
        }

        feedButton.addEventListener('click', () => {
            handleActionButton('feed', actionImages.feed, 'ë§›ìˆëŠ” ë°¥ì„ ë¨¹ì—ˆì–´ìš”! ğŸ˜‹');
            pet.hunger = Math.min(100, pet.hunger + 15);
        });

        playButton.addEventListener('click', () => {
            handleActionButton('play', actionImages.play, 'ì‹ ë‚˜ê²Œ ë†€ì•˜ì–´ìš”! ğŸ‰');
            pet.happiness = Math.min(100, pet.happiness + 20);
            pet.hunger = Math.max(0, pet.hunger - 5);
        });

        cleanButton.addEventListener('click', () => {
            handleActionButton('clean', actionImages.clean, 'ê¹¨ë—í•˜ê²Œ ì”»ì—ˆì–´ìš”! âœ¨');
            pet.cleanliness = Math.min(100, pet.cleanliness + 30);
            pet.happiness = Math.max(0, pet.happiness - 5);
        });

        submitNameButton.addEventListener('click', async () => {
            const name = butlerNameInput.value.trim();
            if (name) {
                if (db && currentScoreDocId) {
                    try {
                        const leaderboardCollectionPath = `artifacts/${appId}/public/data/leaderboard`;
                        const scoreDocRef = doc(db, leaderboardCollectionPath, currentScoreDocId);
                        await updateDoc(scoreDocRef, {
                            name: name
                        });
                        nameModal.classList.add('hidden');
                        gameOverArea.classList.remove('hidden');
                        console.log("ë­í‚¹ì— ì´ë¦„ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    } catch (e) {
                        console.error("ì´ë¦„ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:", e);
                    }
                }
            } else {
                // ì»¤ìŠ¤í…€ ëª¨ë‹¬ ë˜ëŠ” ë©”ì‹œì§€ ë°•ìŠ¤ë¥¼ ì‚¬ìš©
                const message = "ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!";
                console.warn(message);
                messageBox.textContent = message;
                setTimeout(() => messageBox.textContent = '', 2000);
            }
        });
        
        // Game restart function
        restartButton.addEventListener('click', () => {
            console.log("ê²Œì„ ì¬ì‹œì‘ ë²„íŠ¼ í´ë¦­. ìƒíƒœ ì´ˆê¸°í™” ì¤‘.");
            localStorage.removeItem('tamagotchiGameState');
            currentScoreDocId = null; // Reset the score doc id
            
            // Clear and restart intervals
            clearInterval(gameLoopInterval);
            clearInterval(randomImageInterval);
            clearInterval(scoreUpdateInterval);
            
            gameOverArea.classList.add('hidden');
            nameModal.classList.add('hidden');
            
            // Start a new game
            startNewGame();
            gameLoopInterval = setInterval(updateStats, 1000);
            randomImageInterval = setInterval(setRandomPetImage, 30000);
            scoreUpdateInterval = setInterval(updateCurrentScore, 5000);
        });
        
        // Game initialization on window load
        window.onload = function() {
            initFirebase();
        };
    </script>
</body>
</html>